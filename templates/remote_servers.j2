<?xml version="1.0"?>
{{ ansible_managed | comment('xml') }}
<clickhouse>
  <remote_servers>
{% for clusters_name, shards_name in clickhouse_clusters.items() | list %}
    <{{ clusters_name }}>
{% if clickhouse_distributed_secret is defined %}
        <secret>{{ clickhouse_distributed_secret }}</secret>
{% endif %}
{% for shard_name, settings  in shards_name.items() %}
{% for settings, weights  in settings.items() %}
{% for weight in weights %}
        <shard>
          <weight>{{ weight['weight'] }</weight>
          <internal_replication>true</internal_replication>
{% endfor %}
{% endfor %}
{% for shard_name, hosts in shards_name.items() %}
{% for hosts, replicas in hosts.items() %}
{% for replica in replicas %}
          <replica>
            <host>{{ replica['host'] }}</host>
            <port>{{ replica['port'] | default(9000) }}</port>
{% if 'secure' in replica %}
            <secure>1</secure>
{% endif %}
          </replica>
{% endfor %}
{% endfor %}
      </shard>
{% endfor %}      
    </{{ clusters_name }}>
{% endfor %}
  </remote_servers>
</clickhouse>
